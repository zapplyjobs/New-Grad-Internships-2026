name: Cleanup Discord Posts

on:
  schedule:
    # Run daily at 06:00 UTC (1 AM EST / 2 AM EDT)
    # Runs before peak job posting hours to clear old threads
    - cron: '0 6 * * *'
  workflow_dispatch:
    inputs:
      delete_all_channels:
        description: 'Delete from all category channels'
        required: true
        type: boolean
        default: true
      channel_ids:
        description: 'Specific channel IDs (comma-separated, leave empty if delete_all_channels is true)'
        required: false
        type: string
        default: ''
      hours_ago:
        description: 'Delete posts from last N hours (leave empty unless needed)'
        required: false
        type: string
        default: ''
      older_than_hours:
        description: 'Delete posts OLDER than N hours (48 = 2 days default)'
        required: false
        type: string
        default: '48'
      nuclear_mode:
        description: 'âš ï¸ NUCLEAR MODE: Delete ALL posts regardless of age (requires explicit confirmation)'
        required: true
        type: boolean
        default: false
      dry_run:
        description: 'Dry run (preview without deleting)'
        required: true
        type: boolean
        default: true

# Prevent concurrent runs with update-jobs workflow
concurrency:
  group: job-updates
  cancel-in-progress: false

jobs:
  cleanup:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        ref: main

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Install dependencies
      working-directory: .github/scripts
      run: npm install discord.js@14

    - name: Run cleanup script
      run: node .github/scripts/cleanup-discord-posts.js
      env:
        DISCORD_TOKEN: ${{ secrets.DISCORD_TOKEN }}
        DISCORD_GUILD_ID: ${{ secrets.DISCORD_GUILD_ID }}
        DELETE_ALL_CHANNELS: ${{ inputs.delete_all_channels || 'true' }}
        CHANNEL_IDS: ${{ inputs.channel_ids || '' }}
        HOURS_AGO: ${{ inputs.hours_ago || '' }}
        OLDER_THAN_HOURS: ${{ inputs.older_than_hours || '48' }}
        NUCLEAR_MODE: ${{ inputs.nuclear_mode || 'false' }}
        DRY_RUN: ${{ inputs.dry_run || 'false' }}
        # Category channel IDs (hardcoded - must match update-jobs.yml)
        DISCORD_TECH_CHANNEL_ID: "1429365682948145164"
        DISCORD_AI_CHANNEL_ID: "1446528260627501228"
        DISCORD_DS_CHANNEL_ID: "1446528167362822296"
        DISCORD_SALES_CHANNEL_ID: "1429365752145645670"
        DISCORD_MARKETING_CHANNEL_ID: "1429365805090607206"
        DISCORD_FINANCE_CHANNEL_ID: "1429366120854585434"
        DISCORD_HEALTHCARE_CHANNEL_ID: "1429366171840286781"
        DISCORD_PRODUCT_CHANNEL_ID: "1429366236055081131"
        DISCORD_SUPPLY_CHANNEL_ID: "1429366422613786674"
        DISCORD_PM_CHANNEL_ID: "1429366331836207126"
        DISCORD_HR_CHANNEL_ID: "1429366524459745401"
        # Location-specific channels (uses _INT_ suffix secrets - must match update-jobs.yml)
        DISCORD_REMOTE_USA_CHANNEL_ID: ${{ secrets.DISCORD_REMOTE_USA_INT_CHANNEL_ID }}
        DISCORD_NY_CHANNEL_ID: ${{ secrets.DISCORD_NY_INT_CHANNEL_ID }}
        DISCORD_AUSTIN_CHANNEL_ID: ${{ secrets.DISCORD_AUSTIN_INT_CHANNEL_ID }}
        DISCORD_CHICAGO_CHANNEL_ID: ${{ secrets.DISCORD_CHICAGO_INT_CHANNEL_ID }}
        DISCORD_SEATTLE_CHANNEL_ID: ${{ secrets.DISCORD_SEATTLE_INT_CHANNEL_ID }}
        DISCORD_REDMOND_CHANNEL_ID: ${{ secrets.DISCORD_REDMOND_INT_CHANNEL_ID }}
        DISCORD_MV_CHANNEL_ID: ${{ secrets.DISCORD_MV_INT_CHANNEL_ID }}
        DISCORD_SF_CHANNEL_ID: ${{ secrets.DISCORD_SF_INT_CHANNEL_ID }}
        DISCORD_SUNNYVALE_CHANNEL_ID: ${{ secrets.DISCORD_SUNNYVALE_INT_CHANNEL_ID }}
        DISCORD_SAN_BRUNO_CHANNEL_ID: ${{ secrets.DISCORD_SAN_BRUNO_INT_CHANNEL_ID }}
        DISCORD_BOSTON_CHANNEL_ID: ${{ secrets.DISCORD_BOSTON_INT_CHANNEL_ID }}
        DISCORD_LA_CHANNEL_ID: ${{ secrets.DISCORD_LA_INT_CHANNEL_ID }}

    # NOTE: clear_database feature removed (2025-12-08)
    # posted_jobs.json now uses automatic 7-day TTL archiving
    # No manual clearing needed - archives are managed automatically by PostedJobsManagerV2

    - name: Create cleanup summary
      if: always()
      run: |
        echo "## ðŸ§¹ Discord Cleanup Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Mode:** ${{ inputs.dry_run == true && 'ðŸ” DRY RUN (Preview Only)' || 'âœ… LIVE RUN (Posts Deleted)' }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        if [ "${{ inputs.delete_all_channels || 'true' }}" == "true" ]; then
          echo "**Channels:** All category channels (11 channels)" >> $GITHUB_STEP_SUMMARY
        else
          echo "**Channels:** ${{ inputs.channel_ids }}" >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY
        if [ -n "${{ inputs.hours_ago }}" ]; then
          echo "**Time Range:** Last ${{ inputs.hours_ago }} hours (newer posts)" >> $GITHUB_STEP_SUMMARY
        elif [ -n "${{ inputs.older_than_hours }}" ]; then
          echo "**Time Range:** Older than ${{ inputs.older_than_hours }} hours (older posts)" >> $GITHUB_STEP_SUMMARY
        else
          echo "**Time Range:** All posts" >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Check the job logs above for detailed results." >> $GITHUB_STEP_SUMMARY
